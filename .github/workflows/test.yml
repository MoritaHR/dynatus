name: Run Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java: ['17', '21']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
    
    - name: Cache Clojure dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.m2/repository
          ~/.gitlibs
          ~/.clojure/.cpcache
        key: ${{ runner.os }}-clojure-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clojure-
    
    - name: Install Clojure CLI
      uses: DeLaGuardo/setup-clojure@13.4
      with:
        cli: latest
    
    - name: Run tests
      run: |
        clojure -M:test -m kaocha.runner
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-java-${{ matrix.java }}
        path: target/test-results/
        retention-days: 2

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Clojure CLI
      uses: DeLaGuardo/setup-clojure@12.5
      with:
        cli: latest
    
    - name: Cache clj-kondo
      uses: actions/cache@v3
      with:
        path: ~/.cache/clj-kondo
        key: ${{ runner.os }}-clj-kondo-${{ hashFiles('**/deps.edn') }}
        restore-keys: |
          ${{ runner.os }}-clj-kondo-
    
    - name: Install clj-kondo
      run: |
        curl -sLO https://raw.githubusercontent.com/clj-kondo/clj-kondo/master/script/install-clj-kondo
        chmod +x install-clj-kondo
        sudo ./install-clj-kondo
    
    - name: Run clj-kondo
      run: clj-kondo --lint src test

  check-format:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Install Clojure CLI
      uses: DeLaGuardo/setup-clojure@12.5
      with:
        cli: latest
    
    - name: Install cljfmt
      run: |
        clojure -Ttools install io.github.weavejester/cljfmt '{:git/tag "0.12.0"}' :as cljfmt
    
    - name: Check formatting
      run: |
        clojure -Tcljfmt check

  all-checks-passed:
    needs: [test, lint, check-format]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check if all jobs passed
      run: |
        if [[ "${{ needs.test.result }}" != "success" || \
              "${{ needs.lint.result }}" != "success" || \
              "${{ needs.check-format.result }}" != "success" ]]; then
          echo "One or more checks failed"
          exit 1
        fi
        echo "All checks passed successfully!"